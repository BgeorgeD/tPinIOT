<!DOCTYPE html>
<html lang="ro">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WaterSight - Cloud IoT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS ADAUGAT PENTRU LOGIN (Peste stilul existent) */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 128, 128, 0.95); /* Teal opac */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: white;
        }
        #login-box {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #333; width: 300px;
        }
        #tank-input {
            font-size: 24px; padding: 10px; width: 150px; text-align: center;
            border: 2px solid #008080; border-radius: 8px; margin: 20px 0;
            letter-spacing: 3px; font-weight: bold;
        }
        #connect-btn {
            background: #008080; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 6px; cursor: pointer; width: 100%;
        }
        #connect-btn:hover { background: #006666; }
        .hidden { display: none !important; }

        /* Ajustari mici la carduri */
        .status-badge { font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; color: white; display: inline-block; margin-top: 5px; }
        .bg-ok { background-color: #008080; }
        .bg-alert { background-color: #dc3545; }
    </style>
</head>
<body>

<!-- =========================
     LOGIN SCREEN
     ========================= -->
<div id="login-screen">
    <div id="login-box">
        <h1>üåä WaterSight</h1>
        <p>Introduce»õi codul bazinului:</p>
        <input type="text" id="tank-input" placeholder="0000" maxlength="4">
        <button id="connect-btn" onclick="connectToTank()">Conectare la Cloud</button>
        <p id="error-msg" style="color: red; margin-top: 10px; font-size: 14px; min-height: 20px;"></p>
    </div>
</div>

<!-- =========================
     MAIN INTERFACE
     ========================= -->
<div id="main-interface" class="hidden">

    <!-- SIDENAV -->
    <div id="mySidenav" class="sidenav">
        <a href="#">Menu</a>
        <a href="#" onclick="logout()">Deconectare</a>
    </div>

    <!-- HEADER -->
    <h1 class="site-header">
        WaterSight
        <span id="display-tank-id" style="font-size: 0.6em; opacity: 0.8;"></span>
    </h1>


<!-- ========================= 
     CARD CONTAINER
     ========================= -->
<div class="dashboard-layout">

    <!-- =========================
         LEFT COLUMN ‚Äì MONITORIZARE LIVE
         ========================= -->
    <div class="left-column">

        <div class="card tank-card">

            <!-- Header-style title (old design feel) -->
            <div class="tank-header">
                <h2>Monitorizare Live</h2>
                <span>Date √Æn timp real din Neo4j Cloud</span>
            </div>

            <div class="inner-card-container">

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="temp-badge">
                        Temp: <span id="temp-val">--</span>¬∞C
                    </div>

                    <div id="heat-badge" class="tank-badge bg-ok">
                        √éncƒÉlzitor: OPRIT
                    </div>
                    <canvas id="graph1"></canvas>
                </div>

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="ox-badge">
                        O2: <span id="oxigen-val">--</span> mg/L
                    </div>
                    <div id="air-badge" class="tank-badge bg-ok">
                        Aerator: OPRIT
                    </div>
                    <canvas id="graph2"></canvas>
                </div>

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="ph-badge">
                        pH: <span id="ph-val">--</span>
                    </div>

                    <div id="filt-badge" class="tank-badge bg-ok">
                        Filtru: OPRIT
                    </div>
                    <canvas id="graph3"></canvas>
                </div>

            </div>
        </div>

    </div>

    <!-- =========================
         RIGHT COLUMN ‚Äì CONTROL PANEL
         ========================= -->
    <div class="right-column">

        <div class="card">

            <h2>Control Panel</h2>

            <!-- BUTTON SELECTOR -->
            <div class="control-selector">
                <button onclick="toggleControlCard('manual-card')">
                    Manual Controls
                </button>
                <button onclick="toggleControlCard('limits-card')">
                    Ajustare Limite
                </button>
                <button onclick="toggleControlCard('switch-card')">
                    Switch Tank
                </button>
            </div>

            <!-- MANUAL CONTROLS -->
            <div id="manual-card" class="control-card collapsed">
                <h3>Manual Controls</h3>

                <div class="controls-container">
                    <button class="controls-btn" onclick="trimiteComanda('START_AERATOR')">
                        Start Aerator
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_AERATOR')">
                        Stop Aerator
                    </button>

                    <button class="controls-btn" onclick="trimiteComanda('START_FILTRU')">
                        Start Filtru
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_FILTRU')">
                        Stop Filtru
                    </button>

                    <button class="controls-btn" onclick="trimiteComanda('START_INCALZITOR')">
                        Start √éncƒÉlzire
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_INCALZITOR')">
                        Stop √éncƒÉlzire
                    </button>
                </div>
            </div>

            <!-- LIMITS -->
            <div id="limits-card" class="control-card collapsed">
                <h3>Ajustare Limite</h3>

                <div class="limits-wrapper">
                    <div class="limit-box">
                        <strong>TemperaturƒÉ (¬∞C)</strong><br>
                        Min: <input id="temp-min" type="number" value="20">
                        Max: <input id="temp-max" type="number" value="30">
                    </div>

                    <div class="limit-box">
                        <strong>Oxigen (mg/L)</strong><br>
                        Min: <input id="ox-min" type="number" value="5">
                        Max: <input id="ox-max" type="number" value="10">
                    </div>

                    <div class="limit-box">
                        <strong>pH</strong><br>
                        Min: <input id="ph-min" type="number" value="6.5" step="0.1">
                        Max: <input id="ph-max" type="number" value="8" step="0.1">
                    </div>
                </div>
            </div>


            <!-- SWITCH TANK -->
            <div id="switch-card" class="control-card collapsed login-style-card">
                <h3>Switch Tank</h3>
                <input id="switch-tank-input" type="text" placeholder="0000" maxlength="4">
                <button onclick="switchTank()">Conectare</button>

            </div>

        </div>

    </div>

</div>



<script>

    function toggleControlCard(id) {
    const card = document.getElementById(id);
    card.classList.toggle('collapsed');
}



    // --- VARIABILE GLOBALE ---
    let currentTankID = null;
    let refreshInterval = null;


    function getLimits() {
    return {
        temp: {
            min: Number(document.getElementById('temp-min')?.value),
            max: Number(document.getElementById('temp-max')?.value)
        },
        ox: {
            min: Number(document.getElementById('ox-min')?.value),
            max: Number(document.getElementById('ox-max')?.value)
        },
        ph: {
            min: Number(document.getElementById('ph-min')?.value),
            max: Number(document.getElementById('ph-max')?.value)
        }
    };
}


    function applyAlertStyles(badgeId, value, min, max) {
    const badge = document.getElementById(badgeId);
    if (!badge || min == null || max == null) return;

    const range = max - min;
    const warningZone = range * 0.1; // 10% near limits

    badge.classList.remove('bg-ok', 'bg-alert');

    if (value < min || value > max) {
        badge.classList.add('bg-alert');   // ‚ùå outside limits
    } else if (value < min + warningZone || value > max - warningZone) {
        badge.classList.add('bg-warning'); // ‚ö†Ô∏è near limits
    } else {
        badge.classList.add('bg-ok');      // ‚úÖ normal
    }
}



    // --- 1. CONFIGURARE GRAFICE (Chart.js) ---
   function createChart(ctx, label, color) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: label,
                data: [],
                borderColor: color,
                backgroundColor: color.replace('1)', '0.15)'),
                fill: true,
                tension: 0.35,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: false
                },
                y: {
                    beginAtZero: false,

                    // üîë IMPORTANT PART
                    grace: '15%',   // adds space above & below data
                    ticks: {
                        color: 'white',
                        maxTicksLimit: 5,
                        callback: (val) => Number(val).toFixed(2)
                    },

                    grid: {
                        color: 'rgba(255,255,255,0.15)'
                    }
                }
            }
        }
    });
}


    const chartTemp = createChart(document.getElementById('graph1').getContext('2d'), 'Temp', 'rgba(255, 99, 132, 1)', 20, 30);
    const chartOxigen = createChart(document.getElementById('graph2').getContext('2d'), 'Oxigen', 'rgba(54, 162, 235, 1)', 0, 15);
    const chartPh = createChart(document.getElementById('graph3').getContext('2d'), 'pH', 'rgba(75, 192, 192, 1)', 5, 9);

    // --- 2. LOGICA DE LOGIN ---
    async function connectToTank() {
        const code = document.getElementById('tank-input').value;
        const btn = document.getElementById('connect-btn');
        const err = document.getElementById('error-msg');

        if(code.length < 4) { err.innerText = "Codul trebuie sƒÉ aibƒÉ 4 cifre."; return; }

        btn.innerText = "Verificare Cloud...";

        try {
            // Trimitem cererea la backend
            const res = await fetch('/api/connect', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tank_id: code })
            });
            const data = await res.json();

            if (data.status === 'success') {
                // SUCCES
                currentTankID = code;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-interface').classList.remove('hidden');
                document.getElementById('display-tank-id').innerText = "#" + code;

                // Pornim actualizarea datelor
                refreshInterval = setInterval(updateDashboard, 2000);
            } else {
                err.innerText = "Bazin negƒÉsit sau neconectat.";
                btn.innerText = "Conectare";
            }
        } catch (e) {
            console.error(e);
            err.innerText = "Eroare de re»õea.";
            btn.innerText = "Conectare";
        }
    }


    async function switchTank() {
    const input = document.getElementById('switch-tank-input');
    const code = input.value;

    if (code.length < 4) {
        alert("Cod invalid");
        return;
    }

    try {
        // Stop old polling immediately
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        // Reset UI before attempting connection
        resetDashboardUI();

        const res = await fetch('/api/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tank_id: code })
        });

        const data = await res.json();

        if (data.status === 'success') {
            currentTankID = code;
            document.getElementById('display-tank-id').innerText = "#" + code;

            // Restart polling ONLY after success
            refreshInterval = setInterval(updateDashboard, 2000);

            input.value = "";
        } else {
            alert("Bazin negƒÉsit sau fƒÉrƒÉ date");
            currentTankID = null;
        }

    } catch (e) {
        console.error(e);
        alert("Eroare de re»õea");
        currentTankID = null;
    }
}



    function resetDashboardUI() {
    // Clear text values
    document.getElementById('temp-val').innerText = "--";
    document.getElementById('oxigen-val').innerText = "--";
    document.getElementById('ph-val').innerText = "--";

    // Reset badges
    resetBadge('heat-badge', '√éncƒÉlzitor');
    resetBadge('air-badge', 'Aerator');
    resetBadge('filt-badge', 'Filtru');

    // Clear charts
    [chartTemp, chartOxigen, chartPh].forEach(chart => {
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
    });
}

function resetBadge(id, label) {
    const el = document.getElementById(id);
    el.innerText = `${label}: --`;
    el.className = 'tank-badge bg-ok';
}


    function logout() {
        location.reload(); // Reincarca pagina pentru a reveni la login
    }

    // --- 3. ACTUALIZARE DATE (Polling) ---
    async function updateDashboard() {
        if (!currentTankID) return;

        try {
            const res = await fetch(`/api/data?tank_id=${currentTankID}`);
            const data = await res.json();

            // Verificam daca am primit date valide
            if(data.temperatura !== undefined) {
                const now = new Date().toLocaleTimeString();

                // Actualizare Texte
                document.getElementById('temp-val').innerText = data.temperatura;
                document.getElementById('oxigen-val').innerText = data.oxigen;
                document.getElementById('ph-val').innerText = data.ph;

                // Actualizare Statusuri (Badges)
                updateBadge('heat-badge', '√éncƒÉlzitor', data.incalzitor);
                updateBadge('air-badge', 'Aerator', data.aerator);
                updateBadge('filt-badge', 'Filtru', data.filtru);

                // Actualizare Grafice
                addDataToChart(chartTemp, now, data.temperatura);
                addDataToChart(chartOxigen, now, data.oxigen);
                addDataToChart(chartPh, now, data.ph);

                const limits = getLimits();

                applyAlertStyles('temp-badge', data.temperatura, limits.temp.min, limits.temp.max);
                applyAlertStyles('ox-badge', data.oxigen, limits.ox.min, limits.ox.max);
                applyAlertStyles('ph-badge', data.ph, limits.ph.min, limits.ph.max);


            }
        } catch (error) { console.error("Eroare update:", error); }
    }

    function updateBadge(id, label, status) {
        const el = document.getElementById(id);
        el.innerText = `${label}: ${status}`;
        if(status === 'PORNIT') {
            el.className = 'status-badge bg-alert'; // Rosu daca merge
        } else {
            el.className = 'status-badge bg-ok'; // Verde/Turcoaz daca sta
        }
    }

    function addDataToChart(chart, label, value) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);

    // Keep last N points
    const MAX_POINTS = 20;
    if (chart.data.labels.length > MAX_POINTS) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }

    // ---- DYNAMIC SCALE CONTROL ----
    const data = chart.data.datasets[0].data;

    let min = Math.min(...data);
    let max = Math.max(...data);

    // Minimum visible range (prevents exaggeration)
    const MIN_RANGE = 2;   // adjust per sensor if needed

    if (max - min < MIN_RANGE) {
        const mid = (max + min) / 2;
        min = mid - MIN_RANGE / 2;
        max = mid + MIN_RANGE / 2;
    }

    // Padding so line never touches edges
    const padding = (max - min) * 0.15;
    chart.options.scales.y.min = min - padding;
    chart.options.scales.y.max = max + padding;

    chart.update('none');
}

    // --- 4. COMENZI MQTT ---
    async function trimiteComanda(actiune) {
        if (!currentTankID) return;
        await fetch('/api/control', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tank_id: currentTankID, actiune: actiune })
        });
        // Nu dam alert ca sa fie fluid, dar poti vedea in Network tab
    }
</script>

</body>
</html>