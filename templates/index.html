<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- SIDENAV -->
<div id="mySidenav" class="sidenav">
  <a href="#" id="about">Menu</a>
</div>

<!-- HEADER -->
<h1>WaterSight</h1>

<!-- CARD CONTAINER -->
<div class="card-container">

  <!-- CARD ONE -->
  <div class="card">
    <h2>Tank 1</h2>
    <p>First card description...</p>

    <div class="inner-card-container">
      <div class="inner-card">
        <div class="inner-info-bar">Temperature: 24Â°C</div>
        <h3>Temperature Graph</h3>
        <canvas id="graph1"></canvas>
      </div>
      <div class="inner-card">
        <div class="inner-info-bar">Oxygen: 7.8 mg/L</div>
        <h3>Oxygen Graph</h3>
        <canvas id="graph2"></canvas>
      </div>
      <div class="inner-card">
        <div class="inner-info-bar">pH: 7.2</div>
        <h3>pH Graph</h3>
        <canvas id="graph3"></canvas>
      </div>
    </div>
  </div>

  <!-- CARD TWO -->
  <div class="card">
    <h2>Tank 2</h2>
    <p>Second card description...</p>

    <div class="inner-card-container">
      <div class="inner-card">
        <div class="inner-info-bar">Temperature: 23Â°C</div>
        <h3>Temperature Graph</h3>
        <canvas id="graph4"></canvas>
      </div>
      <div class="inner-card">
        <div class="inner-info-bar">Oxygen: 8.0 mg/L</div>
        <h3>Oxygen Graph</h3>
        <canvas id="graph5"></canvas>
      </div>
      <div class="inner-card">
        <div class="inner-info-bar">pH: 7.3</div>
        <h3>pH Graph</h3>
        <canvas id="graph6"></canvas>
      </div>
    </div>
  </div>
    <!-- CONTROLS BUTTON INSIDE CARD CONTAINER -->
  <div class="controls-container" style="gap: 20px;">
      <button class="controls-btn" onclick="trimiteComanda('START_AERATOR')">
          ðŸ’¨ PornÈ™te Aerator
      </button>

      <button class="controls-btn" onclick="trimiteComanda('START_FILTRU')">
          ðŸ”„ PorneÈ™te Filtru
      </button>
  </div>

</div> <!-- end of card-container -->

</div>



</body>

<!-- CHART.JS DEMO LINE CHARTS -->
<script>
    // 1. Initializare Grafice GOALE
    const ctxTemp = document.getElementById('graph1').getContext('2d');
    const ctxOxigen = document.getElementById('graph2').getContext('2d');
    const ctxPh = document.getElementById('graph3').getContext('2d');

    // Functie ajutatoare pentru configurarea graficelor
    function createChart(ctx, label, color) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Timpul (axa X) va fi adaugat dinamic
                datasets: [{
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.2)'),
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { x: { display: false } }, // Ascundem axa X sa fie curat
                animation: { duration: 0 } // Oprim animatia ca sa nu "danseze" la fiecare secunda
            }
        });
    }

    // Cream cele 3 grafice pentru Tank 1
    const chartTemp = createChart(ctxTemp, 'Temperatura', 'rgba(255, 99, 132, 1)');
    const chartOxigen = createChart(ctxOxigen, 'Oxigen', 'rgba(54, 162, 235, 1)');
    const chartPh = createChart(ctxPh, 'pH', 'rgba(75, 192, 192, 1)');

    // 2. Functia care cere date de la Python (app.py)
    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            const data = await response.json();

            // Verificam daca avem date valide
            if (data.temperatura !== undefined) {
                updateDashboard(data);
            }
        } catch (error) {
            console.error('Eroare la preluarea datelor:', error);
        }
    }

    // --- FUNCTIA PENTRU BUTOANE ---
    async function trimiteComanda(actiune) {
        // Facem butonul sa reactioneze vizual
        alert("Trimit comanda: " + actiune);

        try {
            // Trimitem comanda catre serverul nostru Python (app.py)
            const response = await fetch('/api/control', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ actiune: actiune })
            });

            const result = await response.json();
            console.log("Raspuns server:", result);

        } catch (error) {
            console.error("Eroare la trimiterea comenzii:", error);
        }
    }

    // 3. Functia care actualizeaza ecranul
    function updateDashboard(data) {
        const now = new Date().toLocaleTimeString();

        // --- Actualizare TEXTE (Cardul Tank 1) ---
        // Cautam div-urile care contin textul si le schimbam
        // Nota: Aceasta metoda cauta in inner-card-container primul element
        const cards = document.querySelectorAll('.card')[0]; // Tank 1
        const infos = cards.querySelectorAll('.inner-info-bar');

        infos[0].innerText = `Temperature: ${data.temperatura}Â°C`;
        infos[1].innerText = `Oxygen: ${data.oxigen} mg/L`;
        infos[2].innerText = `pH: ${data.ph}`;

        // --- Actualizare GRAFICE ---
        addDataToChart(chartTemp, now, data.temperatura);
        addDataToChart(chartOxigen, now, data.oxigen);
        addDataToChart(chartPh, now, data.ph);
    }

    function addDataToChart(chart, label, data) {
        // Adaugam date noi
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });

        // Pastram doar ultimele 20 de puncte (sa nu se aglomereze)
        if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets.forEach((dataset) => {
                dataset.data.shift();
            });
        }
        chart.update();
    }

    // 4. Pornim ceasul! (Cere date la fiecare 2 secunde)
    setInterval(fetchData, 2000);

    // Initializam si graficele goale pentru Tank 2 (doar vizual, momentan)
    // Poti repeta logica de mai sus si pentru Tank 2 cand vei avea date
    for(let i=4; i<=6; i++){
         const ctx = document.getElementById('graph'+i).getContext('2d');
         createChart(ctx, 'Demo Tank 2', 'rgba(200, 200, 200, 1)');
    }

</script>

</body>
</html>
