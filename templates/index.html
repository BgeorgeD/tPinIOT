<!DOCTYPE html>
<html lang="ro">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WaterSight - Cloud IoT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS ADAUGAT PENTRU LOGIN (Peste stilul existent) */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 128, 128, 0.95); /* Teal opac */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; color: white;
        }
        #login-box {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: #333; width: 300px;
        }
        #tank-input {
            font-size: 24px; padding: 10px; width: 150px; text-align: center;
            border: 2px solid #008080; border-radius: 8px; margin: 20px 0;
            letter-spacing: 3px; font-weight: bold;
        }
        #connect-btn {
            background: #008080; color: white; border: none; padding: 12px 30px;
            font-size: 18px; border-radius: 6px; cursor: pointer; width: 100%;
        }
        #connect-btn:hover { background: #006666; }
        .hidden { display: none !important; }

        /* Ajustari mici la carduri */
        .status-badge { font-size: 0.8rem; padding: 3px 8px; border-radius: 4px; color: white; display: inline-block; margin-top: 5px; }
        .bg-ok { background-color: #008080; }
        .bg-alert { background-color: #dc3545; }
    </style>
</head>
<body>

<!-- =========================
     LOGIN SCREEN
     ========================= -->
<div id="login-screen">
    <div id="login-box">
        <h1>ðŸŒŠ WaterSight</h1>
        <p>IntroduceÈ›i codul bazinului:</p>
        <input type="text" id="tank-input" placeholder="0000" maxlength="4">
        <button id="connect-btn" onclick="connectToTank()">Conectare la Cloud</button>
        <p id="error-msg" style="color: red; margin-top: 10px; font-size: 14px; min-height: 20px;"></p>
    </div>
</div>

<!-- =========================
     MAIN INTERFACE
     ========================= -->
<div id="main-interface" class="hidden">

    <!-- SIDENAV -->
    <div id="mySidenav" class="sidenav">
        <a href="#">Menu</a>
        <a href="#" onclick="logout()">Deconectare</a>
    </div>

    <!-- HEADER -->
    <h1 class="site-header">
        WaterSight
        <span id="display-tank-id" style="font-size: 0.6em; opacity: 0.8;"></span>
    </h1>


<!-- ========================= 
     CARD CONTAINER
     ========================= -->
<div class="dashboard-layout">

    <!-- =========================
         LEFT COLUMN â€“ MONITORIZARE LIVE
         ========================= -->
    <div class="left-column">

        <div class="card tank-card">

            <!-- Header-style title (old design feel) -->
            <div class="tank-header">
                <h2>Monitorizare Live</h2>
                <span>Date Ã®n timp real din Neo4j Cloud</span>
            </div>

            <div class="inner-card-container">

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="temp-badge">
                        Temp: <span id="temp-val">--</span>Â°C
                    </div>

                    <div id="heat-badge" class="tank-badge bg-ok">
                        ÃŽncÄƒlzitor: OPRIT
                    </div>
                    <canvas id="graph1"></canvas>
                </div>

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="ox-badge">
                        O2: <span id="oxigen-val">--</span> mg/L
                    </div>
                    <div id="air-badge" class="tank-badge bg-ok">
                        Aerator: OPRIT
                    </div>
                    <canvas id="graph2"></canvas>
                </div>

                <div class="inner-card tank-inner">
                    <div class="tank-info" id="ph-badge">
                        pH: <span id="ph-val">--</span>
                    </div>

                    <div id="filt-badge" class="tank-badge bg-ok">
                        Filtru: OPRIT
                    </div>
                    <canvas id="graph3"></canvas>
                </div>

            </div>
        </div>

    </div>

    <!-- =========================
         RIGHT COLUMN â€“ CONTROL PANEL
         ========================= -->
    <div class="right-column">

        <div class="card">

            <h2>Control Panel</h2>

            <!-- BUTTON SELECTOR -->
            <div class="control-selector">
                <button onclick="toggleControlCard('manual-card')">
                    Manual Controls
                </button>
                <button onclick="toggleControlCard('limits-card')">
                    Ajustare Limite
                </button>
                <button onclick="toggleControlCard('switch-card')">
                    Switch Tank
                </button>
            </div>

            <!-- =========================
            EVENT LOG
            ========================= -->
            <div class="card event-log-card">
                <h2>Event Log</h2>
                <ul id="event-log"></ul>
            </div>


            <!-- MANUAL CONTROLS -->
            <div id="manual-card" class="control-card collapsed">
                <h3>Manual Controls</h3>

                <div class="controls-container">
                    <button class="controls-btn" onclick="trimiteComanda('START_AERATOR')">
                        Start Aerator
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_AERATOR')">
                        Stop Aerator
                    </button>

                    <button class="controls-btn" onclick="trimiteComanda('START_FILTRU')">
                        Start Filtru
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_FILTRU')">
                        Stop Filtru
                    </button>

                    <button class="controls-btn" onclick="trimiteComanda('START_INCALZITOR')">
                        Start ÃŽncÄƒlzire
                    </button>
                    <button class="controls-btn" onclick="trimiteComanda('STOP_INCALZITOR')">
                        Stop ÃŽncÄƒlzire
                    </button>
                </div>
            </div>

            <!-- LIMITS -->
            <div id="limits-card" class="control-card collapsed">
                <h3>Ajustare Limite</h3>

                <div class="limits-wrapper">
                    <div class="limit-box">
                        <strong>TemperaturÄƒ (Â°C)</strong><br>
                        Min: <input id="temp-min" type="number" value="20" onchange="saveLimits()">
                        Max: <input id="temp-max" type="number" value="30" onchange="saveLimits()">
                    </div>

                    <div class="limit-box">
                        <strong>Oxigen (mg/L)</strong><br>
                        Min: <input id="ox-min" type="number" value="5" onchange="saveLimits()">
                        Max: <input id="ox-max" type="number" value="10" onchange="saveLimits()">
                    </div>

                    <div class="limit-box">
                        <strong>pH</strong><br>
                        Min: <input id="ph-min" type="number" value="6.5" step="0.1" onchange="saveLimits()">
                        Max: <input id="ph-max" type="number" value="8" step="0.1" onchange="saveLimits()">
                    </div>
                </div>
            </div>


            <!-- SWITCH TANK -->
            <div id="switch-card" class="control-card collapsed login-style-card">
                <h3>Switch Tank</h3>
                <input id="switch-tank-input" type="text" placeholder="0000" maxlength="4">
                <button onclick="switchTank()">Conectare</button>

            </div>

        </div>

    </div>

</div>



<script>

    function toggleControlCard(id) {
    const card = document.getElementById(id);
    card.classList.toggle('collapsed');
}



    // --- VARIABILE GLOBALE ---
    let currentTankID = null;
    let refreshInterval = null;


    function saveLimits() {
        localStorage.setItem('tankLimits', JSON.stringify(getLimits()));
    }

    function loadLimits() {
        const saved = localStorage.getItem('tankLimits');
        if (!saved) return;

        const limits = JSON.parse(saved);

        document.getElementById('temp-min').value = limits.temp.min;
        document.getElementById('temp-max').value = limits.temp.max;

        document.getElementById('ox-min').value = limits.ox.min;
        document.getElementById('ox-max').value = limits.ox.max;

        document.getElementById('ph-min').value = limits.ph.min;
        document.getElementById('ph-max').value = limits.ph.max;
    }



    // --- EVENT LOG STATE ---
    const lastEventState = {
    temp: null,
    ox: null,
    ph: null
};



    function getLimits() {
    return {
        temp: {
            min: Number(document.getElementById('temp-min')?.value),
            max: Number(document.getElementById('temp-max')?.value)
        },
        ox: {
            min: Number(document.getElementById('ox-min')?.value),
            max: Number(document.getElementById('ox-max')?.value)
        },
        ph: {
            min: Number(document.getElementById('ph-min')?.value),
            max: Number(document.getElementById('ph-max')?.value)
        }
    };
}


    function applyAlertStyles(badgeId, value, min, max, typeKey, label) {
    const badge = document.getElementById(badgeId);
    if (!badge || min == null || max == null) return;

    const range = max - min;
    const warningZone = range * 0.1;

    let state = 'ok';

    if (value < min || value > max) {
        state = 'alert';
    } else if (value < min + warningZone || value > max - warningZone) {
        state = 'warning';
    }

    badge.classList.remove('bg-ok', 'bg-warning', 'bg-alert');
    badge.classList.add(`bg-${state}`);

    // ðŸ”‘ LOG ONLY ON STATE CHANGE
    if (lastEventState[typeKey] !== state) {
        if (state !== 'ok') {
            logEvent(label, state, value);
        }
        lastEventState[typeKey] = state;
    }
}




    // --- 1. CONFIGURARE GRAFICE (Chart.js) ---
  function createChart(ctx, label, color) {
    return new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: label,
                    data: [],
                    borderColor: color,
                    backgroundColor: color.replace('1)', '0.12)'),
                    fill: 'start',

                    borderWidth: label === 'pH' ? 4.5 : 3.5,
                    tension: 0.35,

                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: color,
                    pointBorderWidth: 0,

                    /* subtle fill using opacity helper */
                    backgroundColor: color + '22', // ~13% opacity in HEX

                },

                /* MIN LIMIT */
                {
                    data: [],
                    borderColor: 'rgba(255,255,255,0.6)',
                    borderWidth: 2,
                    borderDash: [6, 6],
                    pointRadius: 0,
                    fill: false
                },

                /* MAX LIMIT */
                {
                    data: [],
                    borderColor: 'rgba(255,255,255,0.6)',
                    borderWidth: 2,
                    borderDash: [6, 6],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    ticks: {
                        color: 'rgba(255,255,255,0.9)',
                        font: {
                            weight: '600'
                        },
                        maxTicksLimit: 4,
                        autoSkip: true
                    },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: false,
                    grace: '7%',
                    ticks: {
                        color: 'rgba(255,255,255,0.95)',
                        font: {
                            weight: '600'
                        },
                        maxTicksLimit: 5,
                        precision: 1
                    },
                    grid: {
                        color: 'rgba(255,255,255,0.15)'
                    }
                }
            }
        }
    });
}




const chartTemp = createChart(
    document.getElementById('graph1').getContext('2d'),
    'Temp',
    '#ff4d6d'
);

const chartOxigen = createChart(
    document.getElementById('graph2').getContext('2d'),
    'Oxigen',
    '#1B4965'
);

const chartPh = createChart(
    document.getElementById('graph3').getContext('2d'),
    'pH',
    '#00ffd5'
);


    // --- 2. LOGICA DE LOGIN ---
    async function connectToTank() {
        const code = document.getElementById('tank-input').value;
        const btn = document.getElementById('connect-btn');
        const err = document.getElementById('error-msg');

        if(code.length < 4) { err.innerText = "Codul trebuie sÄƒ aibÄƒ 4 cifre."; return; }

        btn.innerText = "Verificare Cloud...";

        try {
            // Trimitem cererea la backend
            const res = await fetch('/api/connect', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ tank_id: code })
            });
            const data = await res.json();

            if (data.status === 'success') {
                // SUCCES
                currentTankID = code;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-interface').classList.remove('hidden');
                document.getElementById('display-tank-id').innerText = "#" + code;

                // Pornim actualizarea datelor
                refreshInterval = setInterval(updateDashboard, 2000);
            } else {
                err.innerText = "Bazin negÄƒsit sau neconectat.";
                btn.innerText = "Conectare";
            }
        } catch (e) {
            console.error(e);
            err.innerText = "Eroare de reÈ›ea.";
            btn.innerText = "Conectare";
        }
    }


    async function switchTank() {
    const input = document.getElementById('switch-tank-input');
    const code = input.value;

    if (code.length < 4) {
        alert("Cod invalid");
        return;
    }

    try {
        // Stop old polling immediately
        if (refreshInterval) {
            clearInterval(refreshInterval);
            refreshInterval = null;
        }

        // Reset UI before attempting connection
        resetDashboardUI();

        const res = await fetch('/api/connect', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tank_id: code })
        });

        const data = await res.json();

        if (data.status === 'success') {
            currentTankID = code;
            document.getElementById('display-tank-id').innerText = "#" + code;

            // Restart polling ONLY after success
            refreshInterval = setInterval(updateDashboard, 2000);

            input.value = "";
        } else {
            alert("Bazin negÄƒsit sau fÄƒrÄƒ date");
            currentTankID = null;
        }

    } catch (e) {
        console.error(e);
        alert("Eroare de reÈ›ea");
        currentTankID = null;
    }
}



    function resetDashboardUI() {
    // Clear text values
    document.getElementById('temp-val').innerText = "--";
    document.getElementById('oxigen-val').innerText = "--";
    document.getElementById('ph-val').innerText = "--";

    // Reset badges
    resetBadge('heat-badge', 'ÃŽncÄƒlzitor');
    resetBadge('air-badge', 'Aerator');
    resetBadge('filt-badge', 'Filtru');

    // Clear charts
    [chartTemp, chartOxigen, chartPh].forEach(chart => {
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
    });
}

function resetBadge(id, label) {
    const el = document.getElementById(id);
    el.innerText = `${label}: --`;
    el.className = 'tank-badge bg-ok';
}


    function logout() {
        location.reload(); // Reincarca pagina pentru a reveni la login
    }


    function logEvent(type, level, value) {
    const log = document.getElementById('event-log');
    if (!log) return;

    const time = new Date().toLocaleTimeString();
    const li = document.createElement('li');

    li.className = level;
    li.textContent = `[${time}] ${type.toUpperCase()} ${level.toUpperCase()} (${value})`;

    log.prepend(li);

    // Keep log size reasonable
    if (log.children.length > 30) {
        log.removeChild(log.lastChild);
    }
}



    // --- 3. ACTUALIZARE DATE (Polling) ---
    async function updateDashboard() {
        if (!currentTankID) return;

        try {
            const res = await fetch(`/api/data?tank_id=${currentTankID}`);
            const data = await res.json();

            // Verificam daca am primit date valide
            if(data.temperatura !== undefined) {
                const now = new Date().toLocaleTimeString();

                // Actualizare Texte
                document.getElementById('temp-val').innerText = data.temperatura;
                document.getElementById('oxigen-val').innerText = data.oxigen;
                document.getElementById('ph-val').innerText = data.ph;

                // Actualizare Statusuri (Badges)
                updateBadge('heat-badge', 'ÃŽncÄƒlzitor', data.incalzitor);
                updateBadge('air-badge', 'Aerator', data.aerator);
                updateBadge('filt-badge', 'Filtru', data.filtru);

                // Actualizare Grafice
               const limits = getLimits();

                addDataToChart(chartTemp, now, data.temperatura, limits.temp.min, limits.temp.max);
                addDataToChart(chartOxigen, now, data.oxigen, limits.ox.min, limits.ox.max);
                addDataToChart(chartPh, now, data.ph, limits.ph.min, limits.ph.max);


                applyAlertStyles('temp-badge', data.temperatura, limits.temp.min, limits.temp.max, 'temp', 'Temp');
                applyAlertStyles('ox-badge', data.oxigen, limits.ox.min, limits.ox.max, 'ox', 'O2');
                applyAlertStyles('ph-badge', data.ph, limits.ph.min, limits.ph.max, 'ph', 'pH');



            }
        } catch (error) { console.error("Eroare update:", error); }
    }

    function updateBadge(id, label, status) {
        const el = document.getElementById(id);
        el.innerText = `${label}: ${status}`;
        if(status === 'PORNIT') {
            el.className = 'status-badge bg-alert'; // Rosu daca merge
        } else {
            el.className = 'status-badge bg-ok'; // Verde/Turcoaz daca sta
        }
    }

   function addDataToChart(chart, label, value, minLimit = null, maxLimit = null) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);

    const MAX_POINTS = 20;

    if (chart.data.labels.length > MAX_POINTS) {
        chart.data.labels.shift();
        chart.data.datasets.forEach(ds => ds.data.shift());
    }

    /* UPDATE LIMIT LINES */
    if (minLimit != null) {
        chart.data.datasets[1].data = Array(chart.data.labels.length).fill(minLimit);
    }
    if (maxLimit != null) {
        chart.data.datasets[2].data = Array(chart.data.labels.length).fill(maxLimit);
    }

    chart.update('none');
}




    // --- 4. COMENZI MQTT ---
    async function trimiteComanda(actiune) {
        if (!currentTankID) return;
        await fetch('/api/control', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ tank_id: currentTankID, actiune: actiune })
        });
        // Nu dam alert ca sa fie fluid, dar poti vedea in Network tab
    }

    loadLimits();


</script>

</body>
</html>